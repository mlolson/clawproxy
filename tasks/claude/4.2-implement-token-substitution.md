# Task 4.2: Implement Token Substitution

**Assignee:** Claude
**Dependencies:** 2.2
**Status:** Open

## Description

Implement PROXY:xxx token substitution for credential injection.

## Acceptance Criteria

- [ ] Create `src/proxy/substitution.rs`
- [ ] Implement `substitute_tokens()` to replace PROXY:xxx with secrets
- [ ] Implement `format_auth_header()` using service config format
- [ ] Handle unknown tokens gracefully (return error)
- [ ] Use regex for token matching

## Implementation

```rust
// src/proxy/substitution.rs

use crate::error::{ProxyError, Result};
use regex::Regex;
use std::collections::HashMap;
use std::sync::LazyLock;

/// Pattern to match PROXY:xxx tokens
static PROXY_TOKEN_PATTERN: LazyLock<Regex> =
    LazyLock::new(|| Regex::new(r"PROXY:(\w+)").expect("Invalid regex"));

/// Substitute PROXY:xxx tokens with actual secrets
pub fn substitute_tokens(
    input: &str,
    secrets: &HashMap<String, String>,
) -> Result<String> {
    let mut result = input.to_string();

    for cap in PROXY_TOKEN_PATTERN.captures_iter(input) {
        let full_match = cap.get(0).unwrap().as_str();
        let secret_name = cap.get(1).unwrap().as_str();

        let secret_value = secrets
            .get(secret_name)
            .ok_or_else(|| ProxyError::InvalidToken(
                format!("Unknown secret: {}", secret_name)
            ))?;

        result = result.replace(full_match, secret_value);
    }

    Ok(result)
}

/// Format auth header value using config template
pub fn format_auth_header(format: &str, secret: &str) -> String {
    format.replace("{secret}", secret)
}

/// Check if a string contains PROXY:xxx tokens
pub fn contains_proxy_token(input: &str) -> bool {
    PROXY_TOKEN_PATTERN.is_match(input)
}
```

## Token Format

- Pattern: `PROXY:name` where name is alphanumeric/underscore
- Examples: `PROXY:openai`, `PROXY:anthropic`, `PROXY:github_token`

## Auth Format Examples

| Service | auth_format | Secret | Result |
|---------|-------------|--------|--------|
| OpenAI | `Bearer {secret}` | `sk-xxx` | `Bearer sk-xxx` |
| Anthropic | `{secret}` | `sk-ant-xxx` | `sk-ant-xxx` |
| GitHub | `token {secret}` | `ghp_xxx` | `token ghp_xxx` |

## Notes

- Substitution happens in Authorization header values
- Could also happen in request body (future enhancement)
- Never log substituted values
