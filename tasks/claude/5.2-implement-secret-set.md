# Task 5.2: Implement `clawproxy secret set`

**Assignee:** Claude
**Dependencies:** 2.2, 5.1
**Status:** Open

## Description

Implement the command to securely store API secrets.

## Acceptance Criteria

- [ ] Read secret from stdin (for piping) or prompt interactively
- [ ] Write to `secrets/<name>` with mode 600
- [ ] Don't echo input when reading from terminal
- [ ] Print confirmation (masked)
- [ ] Validate secret name (alphanumeric + underscore)

## Implementation

```rust
use std::io::{self, BufRead, Write};

async fn cmd_secret_set(name: &str) -> Result<()> {
    // Validate name
    if !name.chars().all(|c| c.is_alphanumeric() || c == '_') {
        anyhow::bail!("Secret name must be alphanumeric (underscores allowed)");
    }

    let config = Config::load(None)?;
    let secrets_dir = config.secrets_dir();

    // Ensure secrets directory exists
    fs::create_dir_all(&secrets_dir)?;

    // Read secret
    let secret = if atty::is(atty::Stream::Stdin) {
        // Interactive: prompt without echo
        prompt_secret(&format!("Enter secret for '{}': ", name))?
    } else {
        // Piped: read from stdin
        let mut line = String::new();
        io::stdin().lock().read_line(&mut line)?;
        line.trim().to_string()
    };

    if secret.is_empty() {
        anyhow::bail!("Secret cannot be empty");
    }

    // Write secret file
    let secret_path = secrets_dir.join(name);
    fs::write(&secret_path, &secret)?;

    // Set permissions to 600
    #[cfg(unix)]
    {
        use std::os::unix::fs::PermissionsExt;
        fs::set_permissions(&secret_path, fs::Permissions::from_mode(0o600))?;
    }

    // Show masked preview
    let preview = mask_secret(&secret);
    println!("Saved secret '{}' ({})", name, preview);

    Ok(())
}

fn prompt_secret(prompt: &str) -> Result<String> {
    // Use rpassword crate for no-echo input
    print!("{}", prompt);
    io::stdout().flush()?;

    rpassword::read_password()
        .map_err(|e| anyhow!("Failed to read secret: {}", e))
}

fn mask_secret(secret: &str) -> String {
    if secret.len() <= 8 {
        "****".to_string()
    } else {
        format!("{}...{}", &secret[..4], &secret[secret.len()-4..])
    }
}
```

## Usage

```bash
# Interactive
clawproxy secret set openai
Enter secret for 'openai': ****************************
Saved secret 'openai' (sk-p...4x2s)

# Piped
echo "sk-..." | clawproxy secret set openai
Saved secret 'openai' (sk-p...4x2s)
```

## Dependencies

Add `rpassword` and `atty` to Cargo.toml:
```toml
rpassword = "7"
atty = "0.2"
```

## Notes

- Never log the actual secret value
- Trim whitespace from input
- Consider adding `--from-env` flag
