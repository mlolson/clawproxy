# Task 6.2: Unit Tests â€” Router

**Assignee:** Claude
**Dependencies:** 4.1
**Status:** Open

## Description

Write unit tests for URL routing and path rewriting.

## Acceptance Criteria

- [ ] Test prefix matching
- [ ] Test path rewriting
- [ ] Test query string preservation
- [ ] Test no match case
- [ ] Test overlapping prefixes

## Test Cases

```rust
#[cfg(test)]
mod tests {
    use super::*;
    use std::collections::HashMap;

    fn test_services() -> HashMap<String, ServiceConfig> {
        let mut services = HashMap::new();
        services.insert("openai".to_string(), ServiceConfig {
            prefix: "/openai".to_string(),
            upstream: "https://api.openai.com".to_string(),
            secret: "openai".to_string(),
            auth_header: "Authorization".to_string(),
            auth_format: "Bearer {secret}".to_string(),
        });
        services.insert("anthropic".to_string(), ServiceConfig {
            prefix: "/anthropic".to_string(),
            upstream: "https://api.anthropic.com".to_string(),
            secret: "anthropic".to_string(),
            auth_header: "x-api-key".to_string(),
            auth_format: "{secret}".to_string(),
        });
        services
    }

    #[test]
    fn test_match_service_openai() {
        let services = test_services();
        let result = match_service("/openai/v1/chat/completions", &services);

        assert!(result.is_some());
        let (name, config) = result.unwrap();
        assert_eq!(name, "openai");
        assert_eq!(config.upstream, "https://api.openai.com");
    }

    #[test]
    fn test_match_service_anthropic() {
        let services = test_services();
        let result = match_service("/anthropic/v1/messages", &services);

        assert!(result.is_some());
        let (name, _) = result.unwrap();
        assert_eq!(name, "anthropic");
    }

    #[test]
    fn test_match_service_no_match() {
        let services = test_services();
        let result = match_service("/unknown/endpoint", &services);
        assert!(result.is_none());
    }

    #[test]
    fn test_rewrite_path() {
        assert_eq!(
            rewrite_path("/openai/v1/chat", "/openai"),
            "/v1/chat"
        );
        assert_eq!(
            rewrite_path("/anthropic/v1/messages", "/anthropic"),
            "/v1/messages"
        );
    }

    #[test]
    fn test_rewrite_path_preserves_trailing_slash() {
        assert_eq!(
            rewrite_path("/openai/v1/", "/openai"),
            "/v1/"
        );
    }

    #[test]
    fn test_build_upstream_url_without_query() {
        let services = test_services();
        let service = services.get("openai").unwrap();

        let url = build_upstream_url(service, "/openai/v1/chat", None);
        assert_eq!(url, "https://api.openai.com/v1/chat");
    }

    #[test]
    fn test_build_upstream_url_with_query() {
        let services = test_services();
        let service = services.get("openai").unwrap();

        let url = build_upstream_url(
            service,
            "/openai/v1/chat",
            Some("stream=true&model=gpt-4"),
        );
        assert_eq!(url, "https://api.openai.com/v1/chat?stream=true&model=gpt-4");
    }
}
```

## Notes

- Test with realistic API paths
- Consider URL encoding edge cases
- Test empty path after prefix removal
