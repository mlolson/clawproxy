# Task 2.2: Implement Secrets Loading

**Assignee:** Claude
**Dependencies:** 2.1
**Status:** Open

## Description

Implement loading secrets from the filesystem with proper permission checks.

## Acceptance Criteria

- [ ] Implement `load_secret(secrets_dir: &Path, name: &str) -> Result<String>`
- [ ] Implement `load_all_secrets(secrets_dir: &Path, config: &Config) -> Result<HashMap<String, String>>`
- [ ] Read secrets from individual files (e.g., `secrets/openai`)
- [ ] Trim whitespace from secret values
- [ ] Validate secrets directory exists
- [ ] Warn if secrets directory has wrong permissions (should be 700)

## Implementation

```rust
use std::fs;
use std::os::unix::fs::PermissionsExt;
use std::path::Path;
use std::collections::HashMap;

pub fn load_secret(secrets_dir: &Path, name: &str) -> Result<String> {
    let path = secrets_dir.join(name);

    if !path.exists() {
        return Err(ConfigError::SecretNotFound(name.to_string()).into());
    }

    let secret = fs::read_to_string(&path)?;
    Ok(secret.trim().to_string())
}

pub fn load_all_secrets(secrets_dir: &Path, config: &Config) -> Result<HashMap<String, String>> {
    check_secrets_dir_permissions(secrets_dir)?;

    let mut secrets = HashMap::new();
    for service in config.services.values() {
        let secret = load_secret(secrets_dir, &service.secret)?;
        secrets.insert(service.secret.clone(), secret);
    }
    Ok(secrets)
}

fn check_secrets_dir_permissions(path: &Path) -> Result<()> {
    let metadata = fs::metadata(path)?;
    let mode = metadata.permissions().mode();

    // Check if directory is readable only by owner (mode 700)
    if mode & 0o077 != 0 {
        tracing::warn!(
            path = %path.display(),
            mode = format!("{:o}", mode),
            "Secrets directory has permissive permissions, should be 700"
        );
    }
    Ok(())
}
```

## Secret File Format

- One secret per file
- Filename = secret name (e.g., `openai`, `anthropic`)
- File contains just the secret value (API key)
- Trailing newline is trimmed

## Notes

- Don't log secret values, even at trace level
- Consider memory protection (zeroize) for future enhancement
