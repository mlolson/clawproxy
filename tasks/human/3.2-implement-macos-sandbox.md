# Task 3.2: Implement macOS Sandbox

**Assignee:** Human
**Dependencies:** 3.1
**Status:** Open

## Why This Task is Assigned to Human

This task requires testing on macOS and understanding the sandbox-exec system. It's a great opportunity to learn about macOS security features.

## Description

Implement macOS sandboxing using sandbox-exec.

## Acceptance Criteria

- [ ] Create `src/sandbox/macos.rs`
- [ ] Implement profile generation from SandboxConfig
- [ ] Write profile to temp file
- [ ] Build sandbox-exec command
- [ ] Implement exec using nix crate
- [ ] Test manually that secrets are blocked

## How sandbox-exec Works

sandbox-exec is a macOS command that runs a process with restrictions defined in a profile:

```bash
# Test it manually first!
sandbox-exec -p '(version 1)(allow default)(deny file-read* (subpath "/tmp/test"))' cat /tmp/test/secret
# Should fail with "Operation not permitted"
```

## Implementation Steps

1. **Generate Profile String**
```rust
fn generate_profile(config: &SandboxConfig) -> String {
    let mut profile = String::from("(version 1)\n(allow default)\n");

    for path in &config.deny_read {
        profile.push_str(&format!(
            "(deny file-read* (subpath \"{}\"))\n",
            path.display()
        ));
    }

    for path in &config.deny_write {
        profile.push_str(&format!(
            "(deny file-write* (subpath \"{}\"))\n",
            path.display()
        ));
    }

    profile
}
```

2. **Write Profile to Temp File**
```rust
use tempfile::NamedTempFile;

let mut profile_file = NamedTempFile::new()?;
profile_file.write_all(profile.as_bytes())?;
let profile_path = profile_file.into_temp_path();
```

3. **Build and Execute sandbox-exec**
```rust
use nix::unistd::execvp;
use std::ffi::CString;

// Set environment variables first
for (key, value) in &config.env {
    std::env::set_var(key, value);
}

// Build args: sandbox-exec -f <profile> <cmd> <args...>
let sandbox_exec = CString::new("sandbox-exec")?;
let args = vec![
    CString::new("sandbox-exec")?,
    CString::new("-f")?,
    CString::new(profile_path.to_str().unwrap())?,
    CString::new(cmd)?,
    // ... add command args
];

execvp(&sandbox_exec, &args)?;
```

## Testing

```bash
# 1. Create a test secret
mkdir -p /tmp/test-secrets
echo "secret-value" > /tmp/test-secrets/openai

# 2. Run without sandbox - should work
cat /tmp/test-secrets/openai
# Output: secret-value

# 3. Run with sandbox - should fail
cargo run --bin clawproxy-run -- cat /tmp/test-secrets/openai
# Output: cat: /tmp/test-secrets/openai: Operation not permitted
```

## Hints

- The profile file must exist when sandbox-exec reads it
- Use `into_temp_path()` to prevent early deletion
- Test with simple commands like `cat` and `ls` first
- Check Console.app for sandbox denial logs

## Resources

- [Apple Sandbox Guide](https://reverse.put.as/wp-content/uploads/2011/09/Apple-Sandbox-Guide-v1.0.pdf)
- Profile syntax is Scheme-like (Lisp dialect)
