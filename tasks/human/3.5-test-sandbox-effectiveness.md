# Task 3.5: Test Sandbox Effectiveness

**Assignee:** Human
**Dependencies:** 3.2, 3.3, 3.4
**Status:** Open

## Why This Task is Assigned to Human

Security testing requires manual verification on real systems. You need to verify the sandbox actually works on your machine.

## Description

Manually test that the sandbox prevents access to secrets on both platforms.

## Acceptance Criteria

- [ ] Create test scenarios
- [ ] Verify sandbox blocks direct file reads
- [ ] Verify sandbox blocks reads via subprocess
- [ ] Verify normal operations still work
- [ ] Document any platform-specific issues

## Test Scenarios

### 1. Direct Read Test

```bash
# Setup
mkdir -p ~/.config/clawproxy/secrets
echo "super-secret-key" > ~/.config/clawproxy/secrets/test
chmod 600 ~/.config/clawproxy/secrets/test

# Without sandbox (should work)
cat ~/.config/clawproxy/secrets/test
# Output: super-secret-key

# With sandbox (should fail)
clawproxy-run cat ~/.config/clawproxy/secrets/test
# Expected: "Operation not permitted" or "Permission denied"
```

### 2. Subprocess Read Test

```bash
# Create a script that tries to read secrets
cat > /tmp/sneaky.sh << 'EOF'
#!/bin/bash
cat ~/.config/clawproxy/secrets/test
EOF
chmod +x /tmp/sneaky.sh

# With sandbox (should still fail)
clawproxy-run /tmp/sneaky.sh
# Expected: fails to read
```

### 3. Environment Variable Test

```bash
# Verify proxy env vars are set
clawproxy-run env | grep -i proxy
# Expected:
# HTTP_PROXY=http://127.0.0.1:8080
# HTTPS_PROXY=http://127.0.0.1:8080
# http_proxy=http://127.0.0.1:8080
# https_proxy=http://127.0.0.1:8080
```

### 4. Normal Operations Test

```bash
# Verify sandbox doesn't break normal operations
clawproxy-run ls /tmp
clawproxy-run echo "hello world"
clawproxy-run python3 -c "print('works')"
# All should succeed
```

### 5. Network Test

```bash
# Verify network still works (will fail without proxy, but should connect)
clawproxy-run curl -I https://example.com
# Should connect (may fail SSL if proxy not running, that's ok)
```

## Platform-Specific Tests

### macOS

```bash
# Check sandbox is using sandbox-exec
ps aux | grep sandbox-exec
# Should show sandbox-exec process

# Check Console.app for sandbox denials
log show --predicate 'subsystem == "com.apple.sandbox"' --last 5m
```

### Linux

```bash
# Check Landlock is being used (kernel 5.13+)
dmesg | grep -i landlock

# Check kernel version
uname -r
# Should be 5.13+ for Landlock support
```

## Test Report Template

```markdown
## Sandbox Test Report

**Date:** YYYY-MM-DD
**Platform:** macOS 14.x / Ubuntu 24.04 / etc.
**Kernel:** (Linux only)

### Test Results

| Test | Expected | Actual | Pass/Fail |
|------|----------|--------|-----------|
| Direct read blocked | Permission denied | | |
| Subprocess read blocked | Permission denied | | |
| Env vars set | HTTP_PROXY set | | |
| Normal ops work | Success | | |

### Issues Found

- (List any issues)

### Notes

- (Any observations)
```

## Hints

- Test on both macOS and Linux if possible
- Try edge cases (symlinks, relative paths)
- Check if sandbox persists for child processes
- Note any performance impact
