# Task 6.3: Unit Tests â€” Substitution

**Assignee:** Human
**Dependencies:** 4.2
**Status:** Open

## Why This Task is Assigned to Human

Writing tests helps you understand the token substitution logic deeply. This is a great way to learn Rust testing patterns.

## Description

Write comprehensive unit tests for token substitution.

## Acceptance Criteria

- [ ] Test single token replacement
- [ ] Test multiple token replacement
- [ ] Test unknown token handling
- [ ] Test auth header formatting
- [ ] Test edge cases

## Test Cases to Implement

```rust
#[cfg(test)]
mod tests {
    use super::*;
    use std::collections::HashMap;

    fn test_secrets() -> HashMap<String, String> {
        let mut secrets = HashMap::new();
        secrets.insert("openai".to_string(), "sk-12345".to_string());
        secrets.insert("anthropic".to_string(), "sk-ant-67890".to_string());
        secrets.insert("empty".to_string(), "".to_string());
        secrets
    }

    // Basic tests

    #[test]
    fn test_substitute_single_token() {
        let secrets = test_secrets();
        let result = substitute_tokens("Bearer PROXY:openai", &secrets).unwrap();
        assert_eq!(result, "Bearer sk-12345");
    }

    #[test]
    fn test_substitute_token_only() {
        // Just the token, no surrounding text
        let secrets = test_secrets();
        let result = substitute_tokens("PROXY:anthropic", &secrets).unwrap();
        assert_eq!(result, "sk-ant-67890");
    }

    #[test]
    fn test_substitute_multiple_tokens() {
        // TODO: Implement
        // Input: "PROXY:openai and PROXY:anthropic"
        // Expected: "sk-12345 and sk-ant-67890"
    }

    #[test]
    fn test_substitute_same_token_twice() {
        // TODO: Implement
        // Input: "PROXY:openai PROXY:openai"
        // Expected: "sk-12345 sk-12345"
    }

    // Error handling

    #[test]
    fn test_unknown_token_returns_error() {
        let secrets = test_secrets();
        let result = substitute_tokens("Bearer PROXY:unknown", &secrets);
        assert!(result.is_err());
        // TODO: Check error message contains "unknown"
    }

    #[test]
    fn test_no_tokens_returns_unchanged() {
        let secrets = test_secrets();
        let result = substitute_tokens("Bearer sk-real-key", &secrets).unwrap();
        assert_eq!(result, "Bearer sk-real-key");
    }

    // Edge cases

    #[test]
    fn test_empty_input() {
        let secrets = test_secrets();
        let result = substitute_tokens("", &secrets).unwrap();
        assert_eq!(result, "");
    }

    #[test]
    fn test_token_with_empty_secret() {
        // TODO: Implement - what should happen?
        // Option 1: Return error
        // Option 2: Replace with empty string
    }

    #[test]
    fn test_partial_token_not_replaced() {
        // "PROXY:" without name should not match
        let secrets = test_secrets();
        let result = substitute_tokens("PROXY: is a prefix", &secrets).unwrap();
        assert_eq!(result, "PROXY: is a prefix");
    }

    #[test]
    fn test_case_sensitive() {
        // "proxy:openai" should not match (lowercase)
        let secrets = test_secrets();
        let result = substitute_tokens("proxy:openai", &secrets).unwrap();
        assert_eq!(result, "proxy:openai");
    }

    // Auth header formatting

    #[test]
    fn test_format_auth_header_bearer() {
        let result = format_auth_header("Bearer {secret}", "sk-12345");
        assert_eq!(result, "Bearer sk-12345");
    }

    #[test]
    fn test_format_auth_header_plain() {
        let result = format_auth_header("{secret}", "sk-ant-67890");
        assert_eq!(result, "sk-ant-67890");
    }

    #[test]
    fn test_format_auth_header_token_prefix() {
        let result = format_auth_header("token {secret}", "ghp_xxx");
        assert_eq!(result, "token ghp_xxx");
    }

    // Helper function tests

    #[test]
    fn test_contains_proxy_token_true() {
        assert!(contains_proxy_token("Bearer PROXY:openai"));
        assert!(contains_proxy_token("PROXY:test"));
    }

    #[test]
    fn test_contains_proxy_token_false() {
        assert!(!contains_proxy_token("Bearer sk-12345"));
        assert!(!contains_proxy_token("no token here"));
        assert!(!contains_proxy_token("proxy:lowercase"));
    }
}
```

## Running Tests

```bash
# Run all tests
cargo test

# Run only substitution tests
cargo test substitution

# Run with output
cargo test substitution -- --nocapture
```

## Hints

- Use `assert!(result.is_err())` for error cases
- Use `assert_eq!` for value comparisons
- Consider using `#[should_panic]` for tests that should fail
- Test boundary conditions (empty strings, special characters)
