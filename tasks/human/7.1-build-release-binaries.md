# Task 7.1: Build Release Binaries

**Assignee:** Human
**Dependencies:** 6.6
**Status:** Open

## Why This Task is Assigned to Human

Building and testing release binaries requires access to multiple platforms and manual verification. This is hands-on work.

## Description

Build optimized release binaries for all supported platforms.

## Acceptance Criteria

- [ ] Build for macOS (Intel x86_64)
- [ ] Build for macOS (Apple Silicon aarch64)
- [ ] Build for Linux (x86_64)
- [ ] Test each binary on target platform
- [ ] Create release archives

## Build Commands

### Local Build

```bash
# Debug build (fast, for development)
cargo build

# Release build (optimized)
cargo build --release

# Check binary size
ls -lh target/release/clawproxy target/release/clawproxy-run
```

### Cross-Compilation (from macOS)

```bash
# Install cross-compilation tools
rustup target add x86_64-unknown-linux-gnu
rustup target add aarch64-unknown-linux-gnu
brew install filosottile/musl-cross/musl-cross

# Build for Linux x86_64
cargo build --release --target x86_64-unknown-linux-gnu

# Build for Linux ARM64
cargo build --release --target aarch64-unknown-linux-gnu
```

### Using Docker for Linux Builds

```bash
# More reliable cross-compilation
docker run --rm -v $(pwd):/app -w /app rust:latest \
    cargo build --release

# Or use cross tool
cargo install cross
cross build --release --target x86_64-unknown-linux-gnu
```

## Release Archive Structure

```
clawproxy-0.1.0-macos-aarch64/
├── clawproxy
├── clawproxy-run
├── README.md
└── LICENSE

# Create archive
tar -czvf clawproxy-0.1.0-macos-aarch64.tar.gz clawproxy-0.1.0-macos-aarch64/
```

## Testing Checklist

### macOS (Apple Silicon)

- [ ] Binary runs: `./clawproxy --version`
- [ ] Init works: `./clawproxy init`
- [ ] Sandbox works: `./clawproxy-run ls /`
- [ ] No missing dylibs: `otool -L clawproxy`

### macOS (Intel)

- [ ] Binary runs on Intel Mac or Rosetta
- [ ] Same checks as above

### Linux (x86_64)

- [ ] Binary runs: `./clawproxy --version`
- [ ] No missing shared libs: `ldd clawproxy`
- [ ] Sandbox works (kernel 5.13+)

## Build Script

```bash
#!/bin/bash
# build-release.sh

set -e

VERSION=$(grep '^version' Cargo.toml | head -1 | cut -d'"' -f2)
echo "Building clawproxy v${VERSION}"

# Build for current platform
cargo build --release

# Create release directory
PLATFORM=$(uname -s | tr '[:upper:]' '[:lower:]')
ARCH=$(uname -m)
RELEASE_DIR="clawproxy-${VERSION}-${PLATFORM}-${ARCH}"

mkdir -p "$RELEASE_DIR"
cp target/release/clawproxy "$RELEASE_DIR/"
cp target/release/clawproxy-run "$RELEASE_DIR/"
cp README.md "$RELEASE_DIR/"
cp LICENSE "$RELEASE_DIR/" 2>/dev/null || true

# Create archive
tar -czvf "${RELEASE_DIR}.tar.gz" "$RELEASE_DIR"

echo "Created ${RELEASE_DIR}.tar.gz"
ls -lh "${RELEASE_DIR}.tar.gz"

# Cleanup
rm -rf "$RELEASE_DIR"
```

## Optimization Tips

```toml
# Cargo.toml - add for smaller binaries
[profile.release]
lto = true
codegen-units = 1
panic = "abort"
strip = true
```

## Notes

- Test on clean systems (no Rust installed)
- Verify all features work in release builds
- Check binary size is reasonable
- Consider reproducible builds
